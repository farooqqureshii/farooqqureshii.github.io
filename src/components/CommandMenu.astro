---
// Command menu component
---

<div id="command-menu" class="fixed inset-0 z-[1001] hidden">
  <!-- Backdrop -->
  <div 
    id="command-backdrop" 
    class="absolute inset-0 bg-black/20 backdrop-blur-sm transition-opacity duration-75 ease-out opacity-0"
  ></div>

<style>
  #command-container {
    transition: all 0.12s cubic-bezier(0.4, 0, 0.2, 1);
    will-change: transform, opacity;
    transform: translateZ(0);
    backface-visibility: hidden;
  }
  
  #command-container.animate-in {
    animation: slideInFromTop 0.15s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }
  
  #command-container.animate-out {
    animation: slideOutToBottom 0.1s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }
  
  @keyframes slideInFromTop {
    0% {
      opacity: 0;
      transform: translateY(-20px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @keyframes slideOutToBottom {
    0% {
      opacity: 1;
      transform: translateY(0);
    }
    100% {
      opacity: 0;
      transform: translateY(20px);
    }
  }
  
  /* Better font for keyboard shortcuts in command menu */
  #command-menu kbd {
    font-family: "SF Mono", "Monaco", "Inconsolata", "Roboto Mono", "Consolas", "Courier New", monospace !important;
    font-variant-ligatures: none;
    letter-spacing: 0.025em;
  }
</style>
  
  <!-- Menu container -->
  <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
    <div 
      id="command-container"
      class="w-full max-w-lg bg-[#f5f5f5] dark:bg-[#222222] flexoki:bg-flexoki-bg rounded-lg border border-zinc-200 dark:border-zinc-700 flexoki:border-flexoki-ui-3 shadow-xl transform transform-gpu opacity-0 pointer-events-auto sm:max-h-[80vh] max-h-[90vh]"
    >
              <!-- Breadcrumb -->
        <div id="command-breadcrumb" class="px-4 py-2 border-b border-zinc-200 dark:border-zinc-700 flexoki:border-flexoki-ui-3">
          <div class="text-xs text-zinc-500 dark:text-zinc-400 flexoki:text-flexoki-tx-2 flex items-center gap-1">
            <span class="cursor-pointer underline hover:text-zinc-700 dark:hover:text-zinc-200 flexoki:hover:text-flexoki-tx transition-colors" id="breadcrumb-domain">farooqqureshi.com</span>
            <span id="breadcrumb-text"></span>
          </div>
        </div>
      
      <!-- Search input -->
      <div class="hidden sm:flex items-center border-b border-zinc-200 dark:border-zinc-700 flexoki:border-flexoki-ui-3 p-4">
        <svg class="w-4 h-4 text-zinc-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <input
          id="command-input"
          type="text"
          placeholder="What next?"
          class="flex-1 bg-transparent outline-none text-zinc-900 dark:text-zinc-100 flexoki:text-flexoki-tx placeholder-zinc-500 dark:placeholder-zinc-400 flexoki:placeholder-flexoki-tx-2"
          autocomplete="off"
        />
        <div class="flex items-center gap-2">
          <kbd class="hidden sm:inline-flex items-center px-2 py-1 text-xs font-medium text-zinc-500 dark:text-zinc-400 flexoki:text-flexoki-tx-2 bg-[#e8e8e8] dark:bg-[#2a2a2a] flexoki:bg-flexoki-ui rounded border border-[#d4d4d4] dark:border-[#404040] flexoki:border-flexoki-ui-3">
            ESC
          </kbd>
        </div>
      </div>
      
      <!-- Results container -->
      <div id="command-results" class="max-h-96 sm:max-h-96 max-h-64 overflow-y-auto custom-scrollbar">
        <div id="nav-results" class="p-2">
          <!-- All items will be populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>
</div>



<script>
  let origOpenMenu: () => void;
  document.addEventListener('DOMContentLoaded', function() {
    const menu = document.getElementById('command-menu');
    const backdrop = document.getElementById('command-backdrop');
    const container = document.getElementById('command-container');
    const input = document.getElementById('command-input') as HTMLInputElement;
    const navResults = document.getElementById('nav-results');
    const breadcrumbText = document.getElementById('breadcrumb-text');
    const breadcrumbDomain = document.getElementById('breadcrumb-domain');
    
    if (!menu || !backdrop || !container || !navResults || !breadcrumbText || !breadcrumbDomain) return;

    // Navigation items organized by sections
    const navItems = [
      { title: 'Home', url: '/', description: 'Go home', section: 'navigation', shortcut: 'H' },
      { title: 'About', url: '/about', description: 'About me', section: 'navigation', shortcut: 'A' },
      { title: 'Projects', url: '/projects', description: 'View my projects', section: 'navigation', shortcut: 'P' },
      { title: 'Writing', url: '/writing', description: 'Read my writing', section: 'navigation', shortcut: 'W' },
      { title: 'Artifacts', url: '/artifacts', description: 'Browse internet gems', section: 'navigation', shortcut: 'B' },
      { title: 'Other', url: '/other', description: 'Other pages', section: 'navigation', shortcut: 'O' }
    ];

    const linkItems = [
      { title: 'Email', url: 'mailto:farooq.qureshi@outlook.com', description: 'Send me an email', section: 'links', shortcut: 'E' },
      { title: 'Résumé', url: 'https://drive.google.com/file/d/1sM9b3G5AbRIG-kDz68KOzGxeETeKm8rN/view?usp=sharing', description: 'View my résumé', section: 'links', shortcut: 'R' },
      { title: 'LinkedIn', url: 'https://linkedin.com/in/farooqq', description: 'Work & experience', section: 'links', shortcut: 'L' },
      { title: 'GitHub', url: 'https://github.com/farooqqureshii', description: 'Projects and more', section: 'links', shortcut: 'G' },
      { title: 'Curius', url: 'https://curius.app/farooq-qureshi', description: 'What I\'m finding interesting', section: 'links', shortcut: 'C' }
    ];

    // Books data
    const books = [
      { title: 'Everything I Never Told You', author: 'Celeste Ng' },
      { title: 'Belzhar', author: 'Meg Wolitzer' },
      { title: 'Animal Farm', author: 'George Orwell' },
      { title: '1984', author: 'George Orwell' },
      { title: 'Brave New World', author: 'Aldous Huxley' },
      { title: 'Bluets', author: 'Maggie Nelson' },
      { title: 'Sapiens', author: 'Yuval Noah Harari' },
      { title: 'Homo Deus', author: 'Yuval Noah Harari' },
      { title: 'Skin in the Game', author: 'Nassim Nicholas Taleb' },
      { title: 'Dopamine Nation', author: 'Anna Lembke' },
      { title: 'All the Light We Cannot See', author: 'Anthony Doerr' },
      { title: 'The Alchemist', author: 'Paulo Coelho' },
      { title: 'South of the Border, West of the Sun', author: 'Haruki Murakami' },
      { title: 'Klara and the Sun', author: 'Kazuo Ishiguro' },
      { title: 'Wit', author: 'Margaret Edson' },
      { title: 'The Subject Was Roses', author: 'Frank D. Gilroy' },
      { title: 'Outliers', author: 'Malcolm Gladwell' },
      { title: 'Homegoing', author: 'Yaa Gyasi' },
      { title: 'Speedboat', author: 'Renata Adler' },
      { title: 'The Folded Clock', author: 'Heidi Julavits' },
      { title: 'We the Animals', author: 'Justin Torres' },
      { title: 'So Sad Today', author: 'Melissa Broder' },
      { title: 'Milkman', author: 'Anna Burns' },
      { title: 'Weather', author: 'Jenny Offill' },
      { title: 'The Sad Part Was', author: 'Prabda Yoon' },
      { title: 'Call Me Zebra', author: 'Azareen Van der Vliet Oloomi' },
      { title: 'Native Speaker', author: 'Chang-rae Lee' },
      { title: 'Your Utopia', author: 'Bora Chung' },
      { title: 'Temporary', author: 'Hilary Leichter' },
      { title: 'The Employees', author: 'Olga Ravn' },
      { title: 'Drinking Coffee Elsewhere', author: 'ZZ Packer' },
      { title: 'No One Is Talking About This', author: 'Patricia Lockwood' },
      { title: 'The Year of Magical Thinking', author: 'Joan Didion' },
      { title: 'If You Leave Me', author: 'Crystal Hana Kim' },
      { title: 'How Much of These Hills Is Gold', author: 'C Pam Zhang' },
      { title: 'The Loneliness of the Long Distance Runner', author: 'Alan Sillitoe' },
      { title: 'Can\'t and Won\'t', author: 'Lydia Davis' },
      { title: 'A Heartbreaking Work of Staggering Genius', author: 'Dave Eggers' },
      { title: 'Celestial Bodies', author: 'Jokha Alharthi' },
      { title: 'Go Home!', author: 'Edited by Rowan Hisayo Buchanan' },
      { title: 'Interpreter of Maladies', author: 'Jhumpa Lahiri' },
      { title: 'The Emperor of All Maladies', author: 'Siddhartha Mukherjee' },
      { title: 'The Boat', author: 'Nam Le' },
      { title: 'The Ones Who Walk Away from Omelas', author: 'Ursula K. Le Guin' },
      { title: 'The Dispossessed', author: 'Ursula K. Le Guin' },
      { title: 'The Left Hand of Darkness', author: 'Ursula K. Le Guin' },
      { title: 'Frankenstein', author: 'Mary Shelley' },
      { title: 'In Search of Lost Time', author: 'Marcel Proust' },
      { title: 'The Trial', author: 'Franz Kafka' },
      { title: 'To the Lighthouse', author: 'Virginia Woolf' },
      { title: 'The Crucible', author: 'Arthur Miller' },
      { title: 'The Double Helix', author: 'James D. Watson' },
      { title: 'Dune', author: 'Frank Herbert' },
      { title: 'The Electric Kool-Aid Acid Test', author: 'Tom Wolfe' },
      { title: 'Danube', author: 'Claudio Magris' },
      { title: 'The Road to Oxiana', author: 'Robert Byron' },
      { title: 'And the Band Played On', author: 'Randy Shilts' },
      { title: 'Postwar', author: 'Tony Judt' },
      { title: 'The Catcher in the Rye', author: 'J.D. Salinger' },
      { title: 'Middlemarch', author: 'George Eliot' },
      { title: 'The Sun Also Rises', author: 'Ernest Hemingway' },
      { title: 'Midnight\'s Children', author: 'Salman Rushdie' },
      { title: 'The Plague', author: 'Albert Camus' },
      { title: 'The Man Without Qualities', author: 'Robert Musil' },
      { title: 'The Tale of Genji', author: 'Murasaki Shikibu' },
      { title: 'In Cold Blood', author: 'Truman Capote' },
      { title: 'Man\'s Search for Meaning', author: 'Viktor E. Frankl' },
      { title: 'Homage to Catalonia', author: 'George Orwell' },
      { title: 'I Know Why the Caged Bird Sings', author: 'Maya Angelou' },
      { title: 'All the President\'s Men', author: 'Bob Woodward & Carl Bernstein' },
      { title: 'The Warmth of Other Suns', author: 'Isabel Wilkerson' }
    ];

    // Projects data
    const projects = [
      { title: 'okbutpitchit', url: 'https://okbutpitchit.vercel.app/', description: 'Code to Pitch-Ready slides, in an Instant' },
      { title: 'Substack Case Study', url: '/writing/substack/', description: 'Product/strategy case study for Substack growth' },
      { title: 'Code Compass', url: 'https://trycodecompass.vercel.app/', description: 'Understand any GitHub repo and find beginner-friendly issues, fast' },
      { title: 'uOttaHack | Director', url: 'https://www.uottahack.ca/', description: 'Leading the team behind Ottawa\'s largest tech event' },
      { title: 'EchoScope', url: 'https://echoscope.vercel.app/', description: 'Use AI to uncover sentiment, bias, and diversity in YouTube comments' },
      { title: 'Analyzing and predicting housing prices in London', url: 'https://farooq.craft.me/write-up', description: 'Smarter housing price predictions with machine learning' }
    ];

    // Generate random book and project
    const randomBook = books[Math.floor(Math.random() * books.length)];
    const randomProject = projects[Math.floor(Math.random() * projects.length)];

    // Get current theme
    function getCurrentTheme() {
      if (document.documentElement.classList.contains('dark')) {
        return 'dark';
      } else if (document.documentElement.classList.contains('flexoki')) {
        return 'flexoki';
      } else {
        return 'light';
      }
    }

    // Get theme toggle text based on current theme
    function getThemeToggleText() {
      const currentTheme = getCurrentTheme();
      if (currentTheme === 'dark') {
        return 'Toggle Light Mode';
      } else if (currentTheme === 'flexoki') {
        return 'Toggle Light Mode';
      } else {
        return 'Toggle Dark Mode';
      }
    }

    // Removed font toggle

    // Get link color toggle text based on current scheme
    function getLinkColorToggleText() {
      return 'Change Link Color';
    }

    function getBackgroundToggleText() {
      return 'Change Background';
    }

    function getSerifToggleText() {
      const serifEnabled = typeof localStorage !== 'undefined' && localStorage.getItem('serif-mode') === 'true';
      return serifEnabled ? 'Switch to Sans Serif' : 'Switch to Serif Font';
    }

    const otherItems = [
      { title: getThemeToggleText(), url: '#', description: 'Switch theme modes', section: 'customization', action: 'toggle-theme', shortcut: 'T' },
      { title: getLinkColorToggleText(), url: '#', description: 'Cycle through link color schemes', section: 'customization', action: 'toggle-link-color', shortcut: 'C' },
      { title: getBackgroundToggleText(), url: '#', description: 'Cycle none / dotted / grid', section: 'customization', action: 'toggle-background', shortcut: 'S' },
      { title: getSerifToggleText(), url: '#', description: 'Toggle serif font mode', section: 'customization', action: 'toggle-serif', shortcut: 'F' }
    ];

    // Define the item type to include optional action property
    type MenuItem = {
      title: string;
      url: string;
      description: string;
      section: string;
      shortcut?: string;
      action?: string;
    };

    // Order items to match visual display: customization first, then navigation, then links
    const allItems: MenuItem[] = [...otherItems, ...navItems, ...linkItems];
    let selectedIndex = 0;
    let filteredItems: MenuItem[] = [...allItems];

    // Update breadcrumb based on current path
    function updateBreadcrumb() {
      if (!breadcrumbText) return;
      
      const path = window.location.pathname;
      if (path === '/') {
        breadcrumbText.innerHTML = '';
      } else {
        // Remove leading slash and split path
        const pathParts = path.slice(1).split('/').filter(part => part.length > 0);
        if (pathParts.length === 0) {
          breadcrumbText.innerHTML = '';
        } else if (pathParts.length === 1) {
          // For top-level pages like /writing, /projects, show the full path
          breadcrumbText.innerHTML = ' / <span class="cursor-pointer underline hover:text-zinc-700 dark:hover:text-zinc-200 flexoki:hover:text-flexoki-tx transition-colors" data-path="/' + pathParts[0] + '">' + pathParts[0] + '</span>';
        } else {
          // For nested pages like /misc/pencils, show the full path
          let breadcrumbHTML = ' / ';
          pathParts.forEach((part, index) => {
            const currentPath = '/' + pathParts.slice(0, index + 1).join('/');
            breadcrumbHTML += '<span class="cursor-pointer underline hover:text-zinc-700 dark:hover:text-zinc-200 flexoki:hover:text-flexoki-tx transition-colors" data-path="' + currentPath + '">' + part + '</span>';
            if (index < pathParts.length - 1) {
              breadcrumbHTML += ' / ';
            }
          });
          breadcrumbText.innerHTML = breadcrumbHTML;
        }
      }
      
      // Add click handlers to breadcrumb parts
      const breadcrumbParts = breadcrumbText.querySelectorAll('[data-path]');
      breadcrumbParts.forEach(part => {
        part.addEventListener('click', (e) => {
          e.preventDefault();
          const path = (part as HTMLElement).getAttribute('data-path');
          if (path) {
            window.location.href = path;
          }
        });
      });
    }

    // Initialize navigation items
    function renderItems() {
      if (!navResults) return;
      
      navResults.innerHTML = '';
      
      // Group items by section
      const groupedItems = filteredItems.reduce((acc, item) => {
        if (!acc[item.section]) {
          acc[item.section] = [];
        }
        acc[item.section].push(item);
        return acc;
      }, {} as Record<string, MenuItem[]>);
      
      // Define section order: customization first, then match main page
      const sectionOrder = ['customization', 'navigation', 'links'];
      
      // Render each section in the specified order
      sectionOrder.forEach((section) => {
        const items = groupedItems[section];
        if (!items || items.length === 0) return;
        // Section header
        const sectionHeader = document.createElement('div');
        sectionHeader.className = 'text-xs text-zinc-500 dark:text-zinc-400 flexoki:text-flexoki-tx-2 px-3 py-2 capitalize';
        sectionHeader.textContent = section;
        navResults.appendChild(sectionHeader);
        
        // Section items
        items.forEach((item, index) => {
          const globalIndex = filteredItems.indexOf(item);
          const div = document.createElement('div');
          div.className = `flex items-center px-3 py-2 rounded cursor-pointer transition-colors no-theme-transition ${
            globalIndex === selectedIndex 
              ? 'bg-[#e8e8e8]/70 dark:bg-[#2a2a2a]/70 flexoki:bg-flexoki-ui/70' 
              : 'hover:bg-[#e8e8e8]/60 dark:hover:bg-[#2a2a2a]/60 flexoki:hover:bg-flexoki-ui/60'
          }`;
          
          div.innerHTML = `
            <div class="flex-1">
              <div class="text-sm text-zinc-900 dark:text-zinc-100 flexoki:text-flexoki-tx">${item.title}</div>
            </div>
            <div class="flex items-center gap-2">
              ${item.shortcut ? `<div class="hidden sm:flex items-center gap-1"><kbd class="inline-flex items-center px-1.5 py-0.5 text-xs font-medium text-zinc-500 dark:text-zinc-400 flexoki:text-flexoki-tx-2 bg-[#e8e8e8] dark:bg-[#2a2a2a] flexoki:bg-flexoki-ui rounded border border-[#d4d4d4] dark:border-[#404040] flexoki:border-flexoki-ui-3">shift</kbd><span class="text-xs text-zinc-400 dark:text-zinc-500 flexoki:text-flexoki-tx-2">+</span><kbd class="inline-flex items-center px-1.5 py-0.5 text-xs font-medium text-zinc-500 dark:text-zinc-400 flexoki:text-flexoki-tx-2 bg-[#e8e8e8] dark:bg-[#2a2a2a] flexoki:bg-flexoki-ui rounded border border-[#d4d4d4] dark:border-[#404040] flexoki:border-flexoki-ui-3">${item.shortcut}</kbd></div>` : ''}
            </div>
          `;
          
          div.addEventListener('click', () => {
            if (item.action === 'toggle-theme') {
              // Trigger theme toggle
              const themeToggle = document.getElementById('theme-toggle');
              if (themeToggle) {
                themeToggle.click();
              }
              closeMenu();
            } else if (item.action === 'toggle-font') {
              // No-op: font toggle removed
              closeMenu();
            } else if (item.action === 'toggle-link-color') {
              // Toggle link color scheme
              const html = document.documentElement;
              const schemes = ['link-scheme-1', 'link-scheme-2', 'link-scheme-3', 'link-scheme-4'];
              const currentScheme = schemes.find(scheme => html.classList.contains(scheme)) || 'link-scheme-1';
              const currentIndex = schemes.indexOf(currentScheme);
              const nextIndex = (currentIndex + 1) % schemes.length;
              
              // Remove all scheme classes
              schemes.forEach(scheme => html.classList.remove(scheme));
              // Add the next scheme class
              html.classList.add(schemes[nextIndex]);
              
              // Save preference
              localStorage.setItem('link-color-preference', schemes[nextIndex]);
              closeMenu();
            } else if (item.action === 'toggle-background') {
              // Toggle page background pattern through none -> dotted -> grid -> none
              const html = document.documentElement;
              const patterns = ['', 'bg-dotted', 'bg-grid'];
              const classes = ['bg-dotted', 'bg-grid', 'bg-waves']; // ensure old waves removed if present
              const currentPattern = classes.find(p => html.classList.contains(p)) || '';
              const currentIndex = patterns.indexOf(currentPattern);
              const nextPattern = patterns[(currentIndex + 1) % patterns.length];
              // Add next first (if not empty)
              if (nextPattern) html.classList.add(nextPattern);
              // Then remove all known pattern classes except next
              classes.forEach(p => { if (p !== nextPattern) html.classList.remove(p); });
              localStorage.setItem('background-pattern', nextPattern);
              closeMenu();
            } else if (item.action === 'toggle-serif') {
              // Toggle serif font mode
              const html = document.documentElement;
              const serifEnabled = html.classList.contains('serif-mode');
              
              if (serifEnabled) {
                html.classList.remove('serif-mode');
                localStorage.setItem('serif-mode', 'false');
              } else {
                html.classList.add('serif-mode');
                localStorage.setItem('serif-mode', 'true');
                // Load Source Serif Pro font when serif mode is enabled
                if (!document.getElementById('source-serif-font')) {
                  const link = document.createElement('link');
                  link.id = 'source-serif-font';
                  link.rel = 'stylesheet';
                  link.href = 'https://fonts.googleapis.com/css2?family=Source+Serif+Pro:ital,wght@0,400;0,600;0,700;1,400&display=swap';
                  document.head.appendChild(link);
                }
              }
              closeMenu();
            } else {
              window.location.href = item.url;
            }
          });
          
          navResults.appendChild(div);
        });
      });
    }

    // Filter items based on search
    function filterItems(query: string) {
      if (!query.trim()) {
        filteredItems = [...allItems];
      } else {
        filteredItems = allItems.filter(item => 
          item.title.toLowerCase().includes(query.toLowerCase()) ||
          item.description.toLowerCase().includes(query.toLowerCase())
        );
      }
      selectedIndex = 0;
      renderItems();
    }

    let openMenu = function openMenuImpl() {
      // Reset state when opening
      filteredItems = [...allItems];
      selectedIndex = 0;
      if (input) {
        input.value = '';
      }
      
      // Update theme toggle text
      const themeToggleItem = filteredItems.find(item => item.action === 'toggle-theme');
      if (themeToggleItem) {
        themeToggleItem.title = getThemeToggleText();
      }
      
      // Font toggle removed
      
      // Update link color toggle text
      const linkColorToggleItem = filteredItems.find(item => item.action === 'toggle-link-color');
      if (linkColorToggleItem) {
        linkColorToggleItem.title = getLinkColorToggleText();
      }
      
      // Update serif toggle text
      const serifToggleItem = filteredItems.find(item => item.action === 'toggle-serif');
      if (serifToggleItem) {
        serifToggleItem.title = getSerifToggleText();
      }
      
      // Update breadcrumb
      updateBreadcrumb();
      
      menu?.classList.remove('hidden');
      setTimeout(() => {
        container?.classList.remove('opacity-0');
        container?.classList.add('animate-in');
        backdrop?.classList.remove('opacity-0');
      }, 10);
      if (input) {
        input.focus();
      }
      renderItems();
      // Scroll to first item after rendering to ensure it's visible
      setTimeout(() => {
        scrollToSelected();
      }, 50);
    };

    // Close command menu
    function closeMenu() {
      container?.classList.remove('animate-in');
      container?.classList.add('animate-out');
    backdrop?.classList.add('opacity-0');
    setTimeout(() => {
      menu?.classList.add('hidden');
      if (input) {
        input.value = '';
      }
      // Reset filtered items to show all items
      filteredItems = [...allItems];
      selectedIndex = 0;
      renderItems();
      // Reset position for next open
      container?.classList.remove('animate-out');
      container?.classList.add('opacity-0');
      backdrop?.classList.add('opacity-0');
    }, 100);
    }

    // Keyboard navigation
    function handleKeydown(e: KeyboardEvent) {
      if (!menu?.classList.contains('hidden')) {
        const items = filteredItems;
        
        // Check for shortcuts first (Shift + key)
        if (e.shiftKey && !e.ctrlKey && !e.metaKey && !e.altKey) {
          const pressedKey = e.key.toUpperCase();
          const shortcutItem = items.find(item => item.shortcut === pressedKey);
          if (shortcutItem) {
            e.preventDefault();
            if (shortcutItem.action === 'toggle-theme') {
              const themeToggle = document.getElementById('theme-toggle');
              if (themeToggle) {
                themeToggle.click();
              }
              closeMenu();
            } else if (shortcutItem.action === 'toggle-font') {
              // No-op: font toggle removed
              closeMenu();
            } else if (shortcutItem.action === 'toggle-link-color') {
              // Toggle link color scheme
              const html = document.documentElement;
              const schemes = ['link-scheme-1', 'link-scheme-2', 'link-scheme-3', 'link-scheme-4'];
              const currentScheme = schemes.find(scheme => html.classList.contains(scheme)) || 'link-scheme-1';
              const currentIndex = schemes.indexOf(currentScheme);
              const nextIndex = (currentIndex + 1) % schemes.length;
              
              // Remove all scheme classes
              schemes.forEach(scheme => html.classList.remove(scheme));
              // Add the next scheme class
              html.classList.add(schemes[nextIndex]);
              
              // Save preference
              localStorage.setItem('link-color-preference', schemes[nextIndex]);
              closeMenu();
            } else if (shortcutItem.action === 'toggle-background') {
              // Toggle page background pattern through none -> dotted -> grid -> none
              const html = document.documentElement;
              const patterns = ['', 'bg-dotted', 'bg-grid'];
              const classes = ['bg-dotted', 'bg-grid', 'bg-waves'];
              const currentPattern = classes.find(p => html.classList.contains(p)) || '';
              const currentIndex = patterns.indexOf(currentPattern);
              const nextPattern = patterns[(currentIndex + 1) % patterns.length];
              if (nextPattern) html.classList.add(nextPattern);
              classes.forEach(p => { if (p !== nextPattern) html.classList.remove(p); });
              localStorage.setItem('background-pattern', nextPattern);
              closeMenu();
            } else if (shortcutItem.action === 'toggle-serif') {
              // Toggle serif font mode
              const html = document.documentElement;
              const serifEnabled = html.classList.contains('serif-mode');
              
              if (serifEnabled) {
                html.classList.remove('serif-mode');
                localStorage.setItem('serif-mode', 'false');
              } else {
                html.classList.add('serif-mode');
                localStorage.setItem('serif-mode', 'true');
                // Load Source Serif Pro font when serif mode is enabled
                if (!document.getElementById('source-serif-font')) {
                  const link = document.createElement('link');
                  link.id = 'source-serif-font';
                  link.rel = 'stylesheet';
                  link.href = 'https://fonts.googleapis.com/css2?family=Source+Serif+Pro:ital,wght@0,400;0,600;0,700;1,400&display=swap';
                  document.head.appendChild(link);
                }
              }
              closeMenu();
            } else {
              window.location.href = shortcutItem.url;
            }
            return;
          }
        }
        
        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault();
            selectedIndex = (selectedIndex + 1) % items.length;
            renderItems();
            requestAnimationFrame(() => {
              scrollToSelected();
            });
            break;
          case 'ArrowUp':
            e.preventDefault();
            selectedIndex = selectedIndex === 0 ? items.length - 1 : selectedIndex - 1;
            renderItems();
            requestAnimationFrame(() => {
              scrollToSelected();
            });
            break;
          case 'Enter':
            e.preventDefault();
                        if (items[selectedIndex]) {
              const item = items[selectedIndex];
              if (item.action === 'toggle-theme') {
                // Trigger theme toggle
                const themeToggle = document.getElementById('theme-toggle');
                if (themeToggle) {
                  themeToggle.click();
                }
                closeMenu();
              } else if (item.action === 'toggle-font') {
                // No-op: font toggle removed
                closeMenu();
              } else if (item.action === 'toggle-link-color') {
                // Toggle link color scheme
                const html = document.documentElement;
                const schemes = ['link-scheme-1', 'link-scheme-2', 'link-scheme-3', 'link-scheme-4'];
                const currentScheme = schemes.find(scheme => html.classList.contains(scheme)) || 'link-scheme-1';
                const currentIndex = schemes.indexOf(currentScheme);
                const nextIndex = (currentIndex + 1) % schemes.length;
                
                // Remove all scheme classes
                schemes.forEach(scheme => html.classList.remove(scheme));
                // Add the next scheme class
                html.classList.add(schemes[nextIndex]);
                
                // Save preference
                localStorage.setItem('link-color-preference', schemes[nextIndex]);
                closeMenu();
              } else if (item.action === 'toggle-background') {
                // Toggle page background pattern through none -> dotted -> grid -> none
                const html = document.documentElement;
                const patterns = ['', 'bg-dotted', 'bg-grid'];
                const classes = ['bg-dotted', 'bg-grid', 'bg-waves'];
                const currentPattern = classes.find(p => html.classList.contains(p)) || '';
                const currentIndex = patterns.indexOf(currentPattern);
                const nextPattern = patterns[(currentIndex + 1) % patterns.length];
                if (nextPattern) html.classList.add(nextPattern);
                classes.forEach(p => { if (p !== nextPattern) html.classList.remove(p); });
                localStorage.setItem('background-pattern', nextPattern);
                closeMenu();
              } else if (item.action === 'toggle-serif') {
                // Toggle serif font mode
                const html = document.documentElement;
                const serifEnabled = html.classList.contains('serif-mode');
                
                if (serifEnabled) {
                  html.classList.remove('serif-mode');
                  localStorage.setItem('serif-mode', 'false');
                } else {
                  html.classList.add('serif-mode');
                  localStorage.setItem('serif-mode', 'true');
                  // Load Lora font when serif mode is enabled
                  if (!document.getElementById('lora-font')) {
                    const link = document.createElement('link');
                    link.id = 'lora-font';
                    link.rel = 'stylesheet';
                    link.href = 'https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap';
                    document.head.appendChild(link);
                  }
                }
                closeMenu();
              } else {
                window.location.href = item.url;
              }
            }
            break;
          case 'Escape':
            e.preventDefault();
            closeMenu();
            break;
        }
      }
    }

    // Scroll to keep selected item visible
    function scrollToSelected() {
      if (!navResults) return;
      
      // Find all clickable items in the results (skip section headers)
      const items = Array.from(navResults.querySelectorAll('div[class*="cursor-pointer"]'));
      
      if (items.length > 0 && selectedIndex < items.length && selectedIndex >= 0) {
        const selectedElement = items[selectedIndex];
        if (selectedElement) {
          selectedElement.scrollIntoView({
            block: 'nearest',
            behavior: 'smooth'
          });
        }
      }
    }

    // Event listeners
    document.addEventListener('keydown', (e: KeyboardEvent) => {
      // Only enable keyboard shortcuts on desktop
      if (window.innerWidth > 768) {
        // Open menu on Ctrl+K (Windows) or Cmd+K (Mac)
        const activeElement = document.activeElement;
        const isInput = activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA' || (activeElement as HTMLElement).isContentEditable);
        if ((e.ctrlKey || e.metaKey) && e.key === 'k' && !isInput) {
          e.preventDefault();
          console.log('Ctrl+K pressed, opening menu');
          openMenu();
        }
        handleKeydown(e);
      }
    });

    // Command menu button
    const commandButton = document.getElementById('command-menu-button');
    commandButton?.addEventListener('click', () => {
      openMenu();
    });



    backdrop?.addEventListener('click', closeMenu);
    
    // Prevent clicks inside the menu container from closing the menu
    container?.addEventListener('click', (e) => {
      e.stopPropagation();
    });
    
    if (input) {
      input.addEventListener('input', (e: Event) => {
        const target = e.target as HTMLInputElement;
        if (target) {
          filterItems(target.value);
        }
      });
    }

    // Add click handler for domain
    breadcrumbDomain?.addEventListener('click', () => {
      window.location.href = '/';
    });

    // Removed font preference initialization

    // Initialize background pattern preference (default: none)
    const savedBackground = localStorage.getItem('background-pattern');
    if (savedBackground) {
      if (savedBackground) {
        document.documentElement.classList.remove('bg-waves');
        if (savedBackground) document.documentElement.classList.add(savedBackground);
      }
    }

    // Initialize link color preference
    const savedLinkColorPreference = localStorage.getItem('link-color-preference');
    if (savedLinkColorPreference) {
      document.documentElement.classList.add(savedLinkColorPreference);
    } else {
      // Default to blue (scheme 1)
      document.documentElement.classList.add('link-scheme-1');
    }

    // Initial render
    renderItems();
  });
</script> 